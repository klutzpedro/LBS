<analysis>**original_problem_statement:**
The user is building a Geospatial Information System (GIS) web application, WASKITA LBS, deployed on a private VPS. The application's core purpose is to query location and personal data for given phone numbers.

PRODUCT REQUIREMENTS:
1.  **Core Functionality:** Create cases, add target phone numbers, and query for location (via CP API) and personal data (via a private Telegram bot).
2.  **NON GEOINT Search Engine:**
    *   A UI to search for individuals by name, which triggers queries to a Telegram bot.
    *   The primary workflow involves searching a name, fetching all associated NIKs (National Identity Numbers), and then fetching a photo for each NIK.
    *   The user is presented with a selection of cards (photo, name, NIK) to choose the correct target for a deep-dive investigation (querying NIK details, NKK Family Card, and RegNIK Phone Number Registration).
    *   **Pagination:** For searches returning many results (>10), the photo fetching process must be paginated, showing 10 results at a time with a load more option to prevent long waits.
    *   **Caching:** Search results must be cached on the server to avoid re-running slow Telegram queries for the same name.
    *   **UI Features:** The search window must be draggable and minimizable, with a blinking warning message during long-running investigations.
3.  **UI/Bug Fixes:**
    *   Fix data from old searches contaminating new search results (photo leaking to the wrong person).
    *   Fix incomplete data capture when the bot sends many results.
    *   Fix UI state and navigation bugs, especially when loading from history.
    *   Ensure scheduled tasks correctly consume API quota and update the map smoothly without a full-page refresh.
    *   Ensure PDF reports correctly include all data, including photos.

**User's preferred language**: Bahasa Indonesia

**what currently exists?**
A full-stack application using FastAPI and React. The NON GEOINT feature is heavily developed but plagued by bugs and deployment issues. In this session, the agent implemented several major features, including pagination and caching for NON GEOINT searches, fixes for scheduling quota consumption, and smoother map updates. However, the entire development process has been repeatedly and severely blocked by the user's inability to successfully deploy the latest code to their VPS. The agent spent a significant amount of time guiding the user through a full server recovery, fixing issues with PM2, Python virtual environments, port conflicts, and broken npm builds. The application is currently non-functional on the user's VPS due to a backend crash.

**Last working item**:
The agent was helping the user resolve a Login failed error on their VPS. The root cause was identified as a Python  in , which caused the backend service to crash immediately on startup. The agent fixed the syntax error in the codebase, but the user's server was still running the old, broken code. The user has consistently struggled to correctly pull the latest changes from git and restart the services.

-   Last item agent was working: Guiding the user to update their VPS with the latest code to fix a critical backend .
-   Status: BLOCKED
-   Agent Testing Done: N
-   Which testing method agent to use? Manual testing by user after they successfully update and restart their server.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: Backend Crashing on Startup on User's VPS (P0 - CRITICAL BLOCKER)**
-   **Issue 2: Photo Leaking to Incorrect NIKs (P0)**
-   **Issue 3: NON GEOINT Pagination Not Working (P0)**
-   **Issue 4: Family Tree graph is not rendering (P2)**
-   **Issue 5: NKK results only show one family member (P2)**

**Issues Detail:**
-   **Issue 1: Backend Crashing on Startup on User's VPS (P0 - CRITICAL BLOCKER)**
    -   **Attempted fixes:** The agent identified an  in  from the user's logs, fixed the code, and provided the user with  and  commands. The user's server is still running the old code, indicating the commands were not executed successfully. This is a symptom of a larger, recurring deployment problem.
    -   **Next debug checklist:**
        1.  **MUST** guide the user to run .
        2.  **MUST** guide the user to restart the backend with .
        3.  **MUST** ask the user to provide the output of  to confirm the  is gone and the server is running.
    -   **Why fix this issue and what will be achieved with the fix?** The entire application is down. Nothing else can be tested or used until the backend is running.
    -   **Status:** BLOCKED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend
    -   **Blocked on other issue:** This is the primary blocker.

-   **Issue 2: Photo Leaking to Incorrect NIKs (P0)**
    -   **Attempted fixes:** The agent has implemented multiple backend fixes, making the photo-to-NIK association logic progressively stricter. The latest fix requires the photo to be in the same Telegram message as the NIK data, or within a very tight time window.
    -   **Next debug checklist:** This cannot be verified until the user's server is running the latest code (see Issue 1). Once the server is up, the user needs to test a search for a name with multiple NIKs, where only some have photos.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical data integrity bug that ruins the core NON GEOINT feature.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on other issue:** Issue 1: Backend Crashing on Startup on User's VPS

-   **Issue 3: NON GEOINT Pagination Not Working (P0)**
    -   **Attempted fixes:** The agent implemented the full pagination feature (backend and frontend). When the user reported it wasn't working (showing all 40+ results at once), the agent suspected that old, non-paginated search data was being loaded from the cache. The agent implemented a cache-clearing mechanism and instructed the user to wipe the  MongoDB collection.
    -   **Next debug checklist:** This also cannot be verified until the server is running the latest code. After deployment, the user must clear the cache and perform a new search for a name with >10 results to see if only the first 10 appear.
    -   **Why fix this issue and what will be achieved with the fix?** Fixes a critical performance issue that makes the app unusable for common search terms.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on other issue:** Issue 1: Backend Crashing on Startup on User's VPS

-   **Issue 4: Family Tree graph is not rendering (P2)**
    -   **Status:** NOT STARTED
-   **Issue 5: NKK results only show one family member (P2)**
    -   **Status:** NOT STARTED

**In progress Task List**:
-   **Task 1: Stabilize and Restore User's VPS Environment (P0)**
    -   **Where to resume:** Guide the user through pulling the latest code fix and restarting the backend service correctly.
    -   **What will be achieved with this?** A functional, accessible application for the user.
    -   **Status:** BLOCKED
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on something:** User action is required to run commands on their VPS.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) Implement other CP API functions (immigration data: passport WNI/WNA, perlintasan).
    -   (P2) Add Export to Excel/CSV functionality.
-   **Future Tasks:**
    -   Enhance the Family Tree visualization.
    -   Build a more robust database migration tool.

**Completed work in this session**
-   **Critical Support: Full VPS Recovery:** Guided the user through a complete server recovery, fixing issues with PM2, Python virtual environments (), port conflicts, missing frontend  directories, and npm <command>

Usage:

npm install        install all the dependencies in your project
npm install <foo>  add the <foo> dependency to your project
npm test           run this project's tests
npm run <foo>      run the script named <foo>
npm <command> -h   quick help on <command>
npm -l             display usage info for all commands
npm help <term>    search for help on <term>
npm help npm       more involved overview

All commands:

    access, adduser, audit, bugs, cache, ci, completion,
    config, dedupe, deprecate, diff, dist-tag, docs, doctor,
    edit, exec, explain, explore, find-dupes, fund, get, help,
    help-search, hook, init, install, install-ci-test,
    install-test, link, ll, login, logout, ls, org, outdated,
    owner, pack, ping, pkg, prefix, profile, prune, publish,
    query, rebuild, repo, restart, root, run-script, sbom,
    search, set, shrinkwrap, star, stars, start, stop, team,
    test, token, uninstall, unpublish, unstar, update, version,
    view, whoami

Specify configs in the ini-formatted file:
    /root/.npmrc
or on the command line via: npm <command> --key=value

More configuration info: npm help config
Configuration fields: npm help 7 config

npm@10.8.2 /usr/lib/node_modules/npm dependency/script errors.
-   **Critical Support: User Data Recovery:** Helped the user restore the  user in their MongoDB database after it was accidentally deleted, including generating and updating the correct password hash.
-   **Feature: NON GEOINT Pagination & Caching:** Implemented a system to fetch photos in batches of 10 for searches with many results, and to cache results to avoid slow re-queries.
-   **Bug Fix: Photo Leaking (Multiple Attempts):** Implemented a much stricter logic to prevent photos from one person being incorrectly associated with another during the NON GEOINT search.
-   **Bug Fix: Scheduling Quota:** Fixed a bug where scheduled tasks did not consume API quota.
-   **Performance: Smooth Map Updates:** Reworked map updates to be smooth, preventing the entire map from reloading on a scheduled refresh.
-   **Bug Fix: Scheduling Feature:** Fixed multiple bugs preventing the creation and cancellation of schedules, primarily by adding missing authorization headers to API calls.
-   **Feature: Photos in PDF Report:** Added target photos to the downloadable PDF reports.
-   **UI: Vertical Photo Layout:** Changed the photo selection UI to a vertical 2-column grid based on user feedback.

**Earlier issues found/mentioned but not fixed**
-   Family Tree graph is not rendering.
-   NKK results only show one family member instead of all.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** **User's deployment environment.** This is the #1 recurring issue. The user consistently struggles to follow deployment and update instructions (using git, npm, pm2), leading to a cycle of fixing issues that the user cannot see.
-   **Recurrence count:** High (10+).
-   **Status:** BLOCKED

**Code Architecture**


**Key Technical Concepts**
-   **User Environment Management:** The user's VPS is the main bottleneck. The user is non-technical and requires extremely clear, step-by-step, copy-pasteable commands for git, pm2, npm, and system services.
-   **Fragile Data Scraping:** The core logic of parsing unstructured data from a Telegram bot remains a high-risk area, as evidenced by the recurring photo leaking bug.

**key DB schema**
-   **users:** The  user was manually recreated after the collection was found empty.
-   **non_geoint_searches:** Schema now supports pagination with fields like , . This collection should be cleared on the user's VPS to ensure the pagination logic works correctly.
-   **cases, targets:** Data was confirmed to still exist after the  collection was found empty.

**All files of reference**
-   : The main backend logic file, containing all recent critical fixes.
-   : The component for the NON GEOINT feature.
-   : The parent component managing global state.

**Critical Info for New Agent**
-   **MUST communicate in Bahasa Indonesia.**
-   **The user's VPS is the #1 BLOCKER.** The backend is currently crashed due to an  because the user has not successfully pulled the latest code. Your absolute first priority is to guide the user to run  and  and verify from the logs that the server is running without that error.
-   **Login is BROKEN on the user's VPS.** This is a direct result of the backend being down.
-   **Assume any user bug report is due to old code.** Do not attempt to fix UI or logic bugs until you have confirmation (via logs or other commands) that the user is running the latest version from git.
-   The user has recently had data loss issues (deleted  collection). Be extremely careful when providing any commands that modify the database.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Login still failing.
2.  **Agent:** Fixed  in  and provided update instructions.
3.  **User:** Login failed after agent provided curl/db commands.
4.  **Agent:** Provided instructions to update password hash in MongoDB.
5.  **User:** Login still failed.
6.  **Agent:** Discovered  collection was empty and guided user to recreate  user.
7.  **User:** Reports database is empty.
8.  **Agent:** Investigated and found only  was empty, other data was intact.
9.  **User:** Reports photo leak and pagination not working.
10. **Agent:** Provided a fix for the photo leak and instructions on how to clear the cache for pagination to work.

**Project Health Check:**
-   **Broken:** The application is in a critical, non-functional state on the user's production VPS. The backend is crashing on startup, making the entire application inaccessible.

**3rd Party Integrations**
-   **Telethon:** Live integration for querying a private Telegram bot.
-   **CP API ():** External JSON API for position queries.
-   **Leaflet.js & OpenStreetMap:** For map rendering.
-   **jsPDF & html2canvas:** For client-side PDF generation.

**Testing status**
-   Testing agent used after significant changes: NO
-   Test files created: []
-   Known regressions: The entire application on the user's VPS has regressed to a non-working state due to deployment failures.

**Credentials to test flow:**
-   **Web App Login:**
    -   Username: 
    -   Password: 
-   **VPS Access:**
    -   The agent does not have direct access. All instructions must be provided to the user as bash commands.

**What agent forgot to execute**
-   The agent has been stuck in a reactive loop of debugging the user's server. A more proactive approach may be needed, such as creating a single, robust update script for the user to run, to minimize the chance of user error during deployment. The core issue of the user's difficulty with server management has not been fully resolved.</analysis>
