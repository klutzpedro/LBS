<analysis>**original_problem_statement:**
The user is enhancing a Geospatial Information System (GIS) web application named NETRA with a strong focus on advanced Open-Source Intelligence (OSINT) features and user experience improvements.

PRODUCT REQUIREMENTS (session additions in **bold**):
1.  **Bug Fixes & UX:**
    *   Fix an issue where selecting a target from a list does not open the correct info popup on the map.
    *   **Fix an issue where the map and target position data do not auto-refresh after a query completes.**
    *   **Fix an incorrect status (completed instead of waiting_selection or no data) in the Full Query history.**
    *   **Implement a global query lock to prevent multiple users from running queries simultaneously, with a clear IDLE/BUSY status indicator.**
    *   **Add a scrollbar to the Kelola User (User Management) dialog to handle long user lists.**
    *   **Remove non-functional Gunakan (Use) buttons from the Simple Query history.**
2.  **Feature Enhancements:**
    *   **Implement a FAKTA OSINT feature within PENDALAMAN LANJUTAN.** This feature should:
        *   Analyze internal data (NIK, NKK, Passport, etc.) and external data (web search, social media).
        *   Search for data on family members (from NKK) in the application's cache.
        *   Use an AI model (via ) to generate a comprehensive Anteseden Intelijen report covering identity, activities, network, assets, and risk assessment.
        *   Display a special icon upon completion.
        *   Add the results to the PDF report and the View Details dialog.
        *   **Cache the results permanently so they are available in the history.**
    *   **Implement a SOCIAL NETWORK ANALYTICS (SNA) feature.** This feature should:
        *   Grab social media profile links from the FAKTA OSINT results.
        *   Scrape public data like follower/friend counts.
        *   Generate a Social Network Analysis graph visualization.
        *   Use AI to summarize the target's network, identifying key connections and affiliations.

**User's preferred language**: Bahasa Indonesia

**what currently exists?**
The application is a full-stack React/FastAPI/MongoDB GIS platform. This session saw a massive expansion of the OSINT capabilities with the implementation of the FAKTA OSINT feature. This feature aggregates internal data (NIK, NKK, Perlintasan) with external web search results, performs cached lookups for family members, and uses an AI model to generate a detailed intelligence antecedent report.

Numerous critical bug fixes and UX improvements were also completed:
-   **Query Auto-Refresh:** A bug preventing the map from automatically updating after a position query was fixed.
-   **OSINT Caching:** The FAKTA OSINT results are now correctly saved to the  collection and are accessible from the history.
-   **History Status Logic:** The status badge in the Full Query history now correctly displays waiting_selection, no data, or completed based on the search outcome and whether an investigation has started.
-   **Global Query Lock:** A system-wide lock prevents concurrent queries. The UI now clearly shows an IDLE (green) or BUSY (red, pulsing) status.
-   **UI Fixes:** Unused buttons in Simple Query were removed, and a scrollbar was added to the User Management dialog.
-   The  was successfully added to the environment to enable the AI summary generation.

**Last working item**:
-   Last item agent was working: The agent began implementing the SOCIAL NETWORK ANALYTICS (SNA) feature, as requested by the user. The initial backend endpoint () and frontend plumbing (state management, button handler, function stubs) were created.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? both
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: Map popup interaction is broken (P0)
-   Issue 2: User-side deployment issue for Passport (NIK) query (P1)
-   Issue 3: OSINT features (Medsos-1, Medsos-2) not working on user's VPS (P1)
-   Issue 4: Recurring user login lockout on VPS (P2)

**Issues Detail:**
-   **Issue 1: Map popup interaction is broken (P0)**
    -   **Description:** A critical regression bug where clicking a target on the map causes other overlapping markers to become unclickable and the popup itself to behave erratically. This was not addressed in this session.
    -   **Attempted fixes:** (From previous fork) Complex  and  hooks in .
    -   **Next debug checklist:**
        1.  Simplify the state management in .
        2.  Consider an event-driven approach to open popups directly on marker refs instead of relying on .
        3.  Investigate Leaflet's event propagation.
    -   **Why fix this issue and what will be achieved with the fix?** This is a core functionality degradation that makes map interaction frustrating and unusable for targets in close proximity.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend
    -   **Blocked on other issue:** None

-   **Issue 2: User-side deployment issue for Passport (NIK) query (P1)**
    -   **Description:** User reported a  error on their production VPS, likely due to stale code. Not addressed this session.
    -   **Next debug checklist:** Guide the user to , restart services, and check  on their VPS.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Manual testing by user on VPS.
    -   **Blocked on other issue:** None

-   **Issue 3: OSINT features (Medsos-1, Medsos-2) not working on user's VPS (P1)**
    -   **Description:** User reported that social media search features return no results on their VPS.
    -   **Attempted fixes:** Agent diagnosed it as missing dependencies in the user's venv and provided the correct  command.
    -   **Next debug checklist:** Confirm with the user that they have run the install command and restarted the backend.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Manual testing by user on VPS.
    -   **Blocked on other issue:** None

-   **Issue 4: Recurring user login lockout on VPS (P2)**
    -   **Description:** User gets locked out due to an active session error. Not addressed this session.
    -   **Next debug checklist:** Review login logic in  to ensure  correctly clears old sessions.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   **Task 1: Implement SOCIAL NETWORK ANALYTICS functionality (P0)**
    -   **Where to resume:** The backend endpoint () and frontend function stubs (, ) are in place in  and . The next steps are:
        1.  **Backend:** Implement the logic in  to scrape public data from social media URLs, generate graph data, and use the AI for analysis.
        2.  **Frontend:** Create a new dialog to display the SNA graph (using a library like Recharts or D3) and the AI-generated summary.
    -   **What will be achieved with this?** This will complete the PENDALAMAN LANJUTAN feature set, providing advanced social network insights.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on something:** None

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   (P1) Implement CALL DATA RECORDER functionality, the last remaining placeholder.
    *   (P1) Create a frontend UI for viewing Admin Security Logs ( endpoint exists).
    *   (P2) Implement social media search by Full Name.
    *   (P2) User Verification: The fix for parsing NKK data with multiple family members requires verification with real data from the user.
*   **Future Tasks:**
    *   (P1) **Refactor the monolithic **. This is a high-priority task for long-term stability and maintainability.
    *   (P2) Add Export to Excel/CSV functionality for query results.
    *   (P2) Implement a Re-fetch foto feature for old Full Query results.

**Completed work in this session**
-   **FAKTA OSINT Feature:** Fully implemented a comprehensive OSINT analysis feature including AI-powered antecedent generation, internal data integration, family cache lookup, and permanent storage of results.
-   **Query Auto-Refresh Fix:** Corrected a bug where the map and target list did not update automatically after a position query.
-   **History Status Fix:** Implemented correct status logic (waiting selection, no data, completed) in the Full Query history view.
-   **Global Query Lock:** Built a system-wide lock to prevent concurrent queries, with a clear UI status indicator.
-   **UI/UX Improvements:** Added a scrollbar to the User Management dialog and removed unused buttons from the Simple Query history dialog.
-   **AI Key Setup:** Successfully configured the  in the environment to enable AI features.

**Earlier issues found/mentioned but not fixed**
-   The critical P0 map popup interaction bug remains the most significant unresolved issue from previous forks.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Map popup interaction is broken.
-   **Recurrence count:** 3+
-   **Status:** NOT STARTED

-   **Issue recurrence in previous fork:** NKK Table only shows one family member.
-   **Recurrence count:** 2
-   **Status:** USER VERIFICATION PENDING

-   **Issue recurrence in previous fork:** User login lockout on VPS.
-   **Recurrence count:** 2
-   **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Comprehensive AI Prompts:** The AI prompt for FAKTA OSINT was significantly enhanced to request a structured Anteseden Intelijen report, synthesizing internal data, external search results, and family cache findings.
-   **Cross-Collection Data Aggregation & Caching:** The FAKTA OSINT feature now fetches data from  and , searches for related family NIKs in the cache, and stores the final compiled report back into the  document for persistence.
-   **Global System Locking:** A backend  combined with a frontend polling endpoint () is used to manage system-wide resource contention and provide real-time UI feedback.
-   **Optimistic UI & State Refinement:** The position query auto-refresh was fixed by directly updating the  state with new data from polling, rather than re-fetching the entire list, providing a smoother user experience.

**key DB schema**
-   : The schema was effectively updated to include an  object, which now stores the complete, persistent FAKTA OSINT report.
-   : The schema now implicitly includes  when an investigation is linked, and the  field's meaning has been refined.
-   : Used as a transient collection to track the state of an in-progress OSINT job.

**All files of reference**
-   
-   
-   
-   
-   
-   

**Areas that need refactoring**:
-   **:** The file has grown even larger and more complex. Refactoring it into a modular structure (e.g., , , ) is critically needed to ensure future maintainability.
-   **:** This component now manages state for search, investigation, OSINT, and SNA. It is a candidate for being broken down into smaller, more focused components.
-   **:** The component's logic is flawed and needs a complete rewrite to fix the P0 popup bug.

**key api endpoints**
-   ****: (NEW) Starts a FAKTA OSINT analysis job.
-   ****: (NEW) Polls the status and result of an OSINT job.
-   ****: (NEW) Starts a Social Network Analysis job.
-   ****: (NEW) Returns the global query engine status (idle/busy).
-   ****: (UPDATED) Returns search history; the frontend now interprets the status field differently.
-   ****: (UPDATED) The frontend logic handling the response from this endpoint was improved to provide better auto-refresh.

**Critical Info for New Agent**
-   **You must respond in Bahasa Indonesia.**
-   The highest priority technical issue is the **P0 map popup interaction bug** in . It has been ignored for several forks and severely degrades core functionality.
-   The user's VPS environment is a common failure point. Be prepared to provide very clear, step-by-step shell commands for , installing dependencies into , and restarting .
-   The  is essential for the FAKTA OSINT feature. Ensure it is present in the backend  file.
-   Proposing a refactor of  is a high-value task that should be brought up with the user when there is a lull in feature requests.

**documents and test reports created in this job**
-    (updated multiple times)

**Last 10 User Messages and any pending HUMAN messages**
-   **10. User:** Requested to remove unused Gunakan buttons from Simple Query history. (DONE)
-   **9. User:** Requested to implement a query lock to prevent multiple users from querying at the same time. (DONE)
-   **8. User:** Reported a bug where a search with no results showed waiting selection instead of no data. (DONE)
-   **7. User:** Reported a bug where a search was marked completed in history before a user selected a target. (DONE)
-   **6. User:** Reported a bug where FAKTA OSINT results were not being saved/cached in the history. (DONE)
-   **5. User:** Requested that FAKTA OSINT also search the cache for data on family members found in the NKK. (DONE)
-   **4. User:** Reported that the map/target list doesn't auto-refresh after a position query. (DONE)
-   **3. User:** Requested FAKTA OSINT be enhanced to generate a full Anteseden Intelijen report using both internal and external data. (DONE)
-   **2. User:** Reported that the FAKTA OSINT summary was missing and provided instructions on how to improve it. (DONE)
-   **1. User:** Requested the implementation of the SOCIAL NETWORK ANALYTICS feature. (IN PROGRESS)

**Project Health Check:**
-   **Broken:**
    -   The UI interaction with map popups for overlapping markers is severely bugged.
-   **Mocked:**
    -   The CALL DATA RECORDER button in the PENDALAMAN LANJUTAN dropdown has no functionality.

**3rd Party Integrations**
-   **Emergent LLM Key (Gemini)**: Used for AI summary generation in FAKTA OSINT.
-   **Maigret, Social-Analyzer, Holehe**: Used in Simple Query OSINT features.
-   **Telethon** (Telegram Bot)
-   **CP API** ()
-   **Leaflet.js & OpenStreetMap**
-   **jsPDF & html2canvas**

**Testing status**
-   Testing agent used after significant changes: NO
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: []
-   Known regressions: The P0 map popup regression from the previous fork persists.

**Credentials to test flow:**
-   **Web App Login:**
    -   Admin Username: 
    -   Admin Password: 

**What agent forgot to execute**
-   The agent correctly prioritized the user's stream of feature requests and bug fixes. Consequently, the long-standing (but not user-mentioned in this session) P0 map popup bug and the  refactoring task were not addressed.</analysis>
