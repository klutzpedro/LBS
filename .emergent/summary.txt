<analysis>**original_problem_statement:**
The user is building a Geospatial Information System (GIS) web application, NETRA, to query location and personal data from external sources (a CP API and a private Telegram bot).

PRODUCT REQUIREMENTS:
1.  **Core Functionality:** Create cases, add targets, and query external APIs for data.
2.  **User Management:** Admin must approve new users. A user's account should only be active on one device at a time.
3.  **UI/UX:**
    *   The main UI should be a floating, draggable Tools Panel.
    *   The application must be branded with the NETRA name and a logo.
    *   The Tools Panel should auto-hide when other dialogs (like Full Query, Simple Query) are open and reappear when they are closed.
    *   The Tools Panel default position should be neatly aligned under the Map Type selector.
4.  **Data Display:** The map marker popup for a location point must show all available details from the Telegram bot (IMEI, IMSI, MCC, CGI, LAC, CI, etc.) and include a Share button to copy the location link.
5.  **Caching & History:** All external queries should be cached. A shared cache and history view for SIMPLE QUERY is required.
6.  **Security & Stability:**
    *   Harden the application against common web vulnerabilities.
    *   Fix race conditions causing data mix-ups between concurrent users.
    *   Fix a bug causing excessive CP API quota usage.
    *   Fix a bug where stale sessions lock users out, requiring them to wait for approval even when no other device is active.

**User's preferred language**: Bahasa Indonesia

**what currently exists?**
A full-stack FastAPI and React application named NETRA. It features a multi-user system with admin approval and data tenancy. The UI has a draggable, floating Tools Panel which contains the main feature buttons. The application has been branded with the NETRA logo.

A single-device login feature has been implemented to prevent concurrent sessions. The initial complex implementation involved an approval flow between devices, which caused several bugs and usability issues. A simpler version that blocks a new login and shows a notification was started but not completed. A session timeout mechanism was also added to clean up stale sessions from the database during new login attempts.

**Last working item**:
-   Last item agent was working: The user requested a much simpler single-device login mechanism. Instead of a complex approval flow, if a user tries to log in while their account is active elsewhere, the new login should be blocked, and a notification should appear saying, akun ini sudah dibuka di tempat lain, mohon logout terlebih dahulu baru login di tempat baru with only an OK button. The agent started implementing this but did not finish.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? both. Use  to test the backend  endpoint to ensure it correctly returns an error when a session is active. Use the  to verify the new notification dialog appears on the frontend login page.
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: Simplify and complete the single-device login feature (P0)**
-   **Issue 2: Verify extended location info in map popup (P1)**
-   **Issue 3: Fix broken Family Tree graph (P2)**

**Issues Detail:**
-   **Issue 1: Simplify and complete the single-device login feature (P0)**
    -   **Attempted fixes:** A complex, buggy approval-based system was implemented. The agent then started refactoring to a simpler block-and-notify system as requested by the user, but the work is incomplete.
    -   **Next debug checklist:**
        1.  In , refactor the  endpoint. Remove all logic related to  and the approval flow.
        2.  The login logic should simply check . If a session for the user exists, return a specific error (e.g., ).
        3.  Delete the  collection and associated backend endpoints (, ) as they are now obsolete.
        4.  In , update the  function. If the API returns the  error, display a simple  with the user-requested message and a single OK button that closes the dialog.
        5.  Remove the polling logic from  and the notification logic from  related to the old approval flow.
        6.  Remove the  environment variable toggle; this feature is now a permanent, simplified part of the application.
    -   **Why fix this issue and what will be achieved with the fix?** To fulfill the user's latest, simplified requirement for session management and eliminate the bugs and complexity of the previous implementation.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None

-   **Issue 2: Verify extended location info in map popup (P1)**
    -   **Attempted fixes:** The backend parser ( in ) was updated to extract MCC, LAC, CI, CGI. The frontend component () was updated to display these new fields. However, it was not tested with real data.
    -   **Next debug checklist:**
        1.  This requires user verification with their live Telegram bot.
        2.  The user needs to perform a location query that returns the full dataset.
        3.  Click the map marker and check if the popup correctly displays all the new fields (IMEI, IMSI, Network, MCC, CGI, LAC, CI).
    -   **Why fix this issue and what will be achieved with the fix?** To complete a user-requested feature to display all available data on the map.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend (Visual Verification)
    -   **Blocked on other issue:** None

-   **Issue 3: Fix broken Family Tree graph (P2)**
    -   **Attempted fixes:** None in this session. This is a known issue from a previous handoff.
    -   **Next debug checklist:**
        1.  Examine .
        2.  Investigate the data structure being passed to the component.
        3.  Debug the d3.js logic, which is likely failing due to an incorrect data format or rendering issue.
    -   **Why fix this issue and what will be achieved with the fix?** To restore a broken data visualization feature.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) Create UI for Admin Security Logs: The backend endpoint  exists, but there is no frontend interface for admins to view these logs.
    -   (P2) Verify NKK Parser Fix: A fix for parsing NKK data with multiple family members was implemented in  but requires user verification with real data.
-   **Future Tasks:**
    -   Add Export to Excel/CSV functionality.
    -   Enhance the Family Tree visualization (after fixing the rendering bug).
    -   Refactor all backend parsers in  for robustness.

**Completed work in this session**
-   **Implemented NETRA Logo:** Successfully added the logo to the Login page and Sidebar.
-   **Fixed Tools Panel UI Logic:** The Tools Panel now correctly hides when other dialogs are opened and reappears when they are closed, including during complex transitions between dialogs (e.g., History -> Full Query). The default position has also been set as per the user's request.
-   **Implemented Use Result from History:** The button in the Simple Query History dialog now correctly populates the Simple Query form with the selected result.
-   **Added Session Timeout & Cleanup:** Implemented logic in the backend to detect and clean up stale sessions (inactive > 30 mins) during a new login attempt, preventing users from being locked out by zombie sessions. This fix, however, is not yet deployed on the user's VPS.
-   **Added Detailed Location Info:** The backend parser and frontend map popup were updated to include additional fields (IMEI, IMSI, MCC, etc.) from the Telegram bot response and a Share button.
-   **(DEPRECATED) Implemented Complex Single-Device Login:** A full approval-based flow was built and then debugged extensively before the user requested it be replaced with a simpler version.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Family Tree Graph Not Rendering Correctly**
    -   **Debug checklist:** Examine  and the data structure being passed to it. The d3.js logic or expected data format is likely incorrect.
    -   **Why to solve this issue and what will be achieved with this?** Restores a data visualization feature, improving the application's analytical capabilities.
    -   **Should Test frontend/backend/both after fix:** Frontend
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** NKK Table only shows one family member.
-   **Recurrence count:** 2
-   **Status:** IN PROGRESS (A fix was implemented in  in , but it requires user verification with real data).

**Code Architecture**


**Key Technical Concepts**
-   **Simplified Single-Device Login:** The new target architecture is to block any login attempt for an account that already has a record in the  collection, returning a simple error to the frontend.
-   **Stale Session Cleanup:** To prevent lockouts from zombie sessions (e.g., user closes browser without logging out), a cleanup mechanism was added. It runs *only* during a new login attempt, checking for sessions with a  timestamp older than 30 minutes and removing them before proceeding.
-   **UI State Race Condition Handling:** The auto-hiding Tools Panel required using  as a transition flag () in  to prevent the panel from incorrectly reappearing during transitions between two different dialogs (e.g., closing a history dialog to open a details dialog).

**key DB schema**
-   ****: . The  field was added to enable stale session detection.
-   ****: . This collection and its related logic should be **removed** as part of the simplification task.

**changes in tech stack**
-   None.

**All files of reference**
-   
-   
-   
-   
-   
-   
-   

**Areas that need refactoring**:
-   The entire single-device login implementation across , , , and  must be refactored to remove the obsolete, complex approval/transfer flow and leave only the simple block-and-notify mechanism.

**key api endpoints**
-   : Heavily modified. Needs to be simplified to just check for an active session and return an error if one exists.
-   **(TO BE DELETED)** , , : These endpoints were part of the complex flow and are now obsolete.
-   : This endpoint was used for polling session validity. Its role will change to not perform stale checks, which are now only done at login.

**Critical Info for New Agent**
-   **You MUST communicate in Bahasa Indonesia.**
-   **The user wants a SIMPLE single-device login.** The complex approval system is **DEPRECATED**. The new logic is: if a session exists, block the new login and show a message. Do not re-implement any transfer/approval logic.
-   **The user's VPS is out of sync.** The user repeatedly reports being locked out because the session-timeout fixes are not on their production server. The solution is to guide them to deploy the latest code, but for now, they are manually clearing the database. The next agent's first task is to implement the simple login, which will eventually be deployed.
-   **Stale session cleanup ONLY happens at login.** The bug where active users were logged out was fixed by moving the stale-check logic from the periodic session validation endpoint to the initial login endpoint. This is a critical distinction to maintain.

**documents and test reports created in this job**
-    (updated)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: I am still getting locked out, waiting for approval when no other device is active. (PENDING - User's VPS code is outdated. Agent provided a manual DB clear command.)
2.  **User**: Can the Tools Panel default position be right under the map type selector? (COMPLETED - Agent adjusted the default position.)
3.  **User**: I suddenly got a Session has ended notification while actively using the app. (COMPLETED - Agent fixed the bug by moving stale session checks to only happen at login.)
4.  **User**: Add all info from the Telegram bot (IMEI, IMSI, etc.) to the map popup and add a share button. (COMPLETED - Implemented but needs user verification.)
5.  **User**: Make the single-device login simpler. Just block the new login with a notification. (IN PROGRESS - Agent started this simplification.)
6.  **User**: I can't log in after approving a device transfer. (COMPLETED - Agent debugged and fixed the entire approval-based login flow, which is now being deprecated.)
7.  **User**: On a new login, the app should wait for approval from the old device. The old device should have approve and reject buttons. (COMPLETED - This complex flow was implemented before the user requested to simplify it.)
8.  **User**: The Use this result button in the history doesn't do anything. (COMPLETED - Agent fixed it to populate the Simple Query dialog.)
9.  **User**: When opening a history item from the history dialog, the Tools Panel reappears when it shouldn't. (COMPLETED - Agent fixed the UI logic with a transition flag.)
10. **User**: The Tools Panel should hide when any feature sub-window is opened. (COMPLETED - Agent implemented this.)

**Project Health Check:**
-   **Broken:**
    -    component does not render the graph.
-   **Mocked:** None.

**3rd Party Integrations**
-   **Telethon (Telegram Bot)**
-   **CP API ()**
-   **Leaflet.js & OpenStreetMap**
-   **jsPDF & html2canvas**

**Testing status**
-   Testing agent used after significant changes: NO
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: []
-   Known regressions: None.

**Credentials to test flow:**
-   **Web App Login:**
    -   Admin Username: 
    -   Admin Password: 

**What agent forgot to execute**
-   The agent started the simplification of the single-device login feature but did not complete it. The agent has left a significant amount of obsolete code from the previous, more complex approval-based system in the frontend and backend that now needs to be identified and removed to avoid confusion and future bugs.</analysis>
